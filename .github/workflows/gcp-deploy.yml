name: Deploy Django to GCP on Push

on:
  push:
    branches:
      - master  # or main if you're using that

jobs:
  deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: nci-research-project
          export_default_credentials: true

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet

      - name: Build and Push Docker Image
        run: |
          docker build -t europe-west1-docker.pkg.dev/nci-research-project/django-repo/django-app:latest .
          docker push europe-west1-docker.pkg.dev/nci-research-project/django-repo/django-app:latest

      - name: Deploy to GKE
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: nci-research-cluster
          location: europe-west1
          project_id: nci-research-project

      - name: Apply Kubernetes Resources
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
